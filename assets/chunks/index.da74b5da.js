var C=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Y={},P={},F={};(function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.getUniqueId=a.mergeTransactions=a.LT_COLLATOR=a.Semaphore=a.DelayedTransactions=a.MessageExpiredException=a.AddressLiteral=a.Address=void 0;class e{constructor(u){this.equals=d=>this._equals(d),this._address=u}toString(){return this._address}toJSON(){return this._address}_equals(u){return u instanceof e?this._address===u._address:this._address===u}}a.Address=e;class t extends e{constructor(u){super(u)}}a.AddressLiteral=t;class r extends Error{constructor(u,d){super("Message expired"),this.address=u,this.hash=d}}a.MessageExpiredException=r;class i{constructor(){this.transactions=new Map}async waitTransaction(u,d){var b;let A=(b=this.transactions.get(d))===null||b===void 0?void 0:b.promise;if(A==null){let M,y;A=new Promise((n,c)=>{M=l=>n(l),y=()=>c()}),this.transactions.set(d,{promise:A,resolve:M,reject:y})}const E=await A;if(E==null)throw new r(u,d);return E}fillTransaction(u,d){const b=this.transactions.get(u);b!=null?b.resolve(d):this.transactions.set(u,{promise:Promise.resolve(d),resolve:()=>{},reject:()=>{}})}}a.DelayedTransactions=i;class s{constructor(u){this.tasks=[],this.sched=()=>{var d;this.count>0&&this.tasks.length>0&&(this.count--,(d=this.tasks.shift())===null||d===void 0||d())},this.count=u}acquire(){return new Promise((u,d)=>{this.tasks.push(()=>{let b=!1;u(()=>{b||(b=!0,this.count++,this.sched())})}),p(this.sched)})}releaseAll(){for(var u;this.tasks.length>0;)(u=this.tasks.shift())===null||u===void 0||u()}}a.Semaphore=s;function o(f){const u=document.createTextNode("");let d,b,A=0,E=0;return new f(function(){let M;if(d)b&&(d=b.slice(E).concat(d));else{if(!b)return;d=b}if(b=d,d=null,E=0,typeof b=="function"){M=b,b=null,M();return}for(u.data=A=++A%2;E<b.length;)M=b[E],E++,E===b.length&&(b=null),M()}).observe(u,{characterData:!0}),function(M){if(d){typeof d=="function"?d=[d,M]:d.push(M);return}d=M,u.data=A=++A%2}}const p=function(){if(typeof queueMicrotask=="function")return queueMicrotask;if(typeof document=="object"&&document){if(typeof MutationObserver=="function")return o(MutationObserver);if(typeof window.WebKitMutationObserver=="function")return o(window.WebKitMutationObserver)}if(typeof setImmediate=="function")return setImmediate;if(typeof setTimeout=="function"||typeof setTimeout=="object")return function(f){setTimeout(f,0)};throw new Error("No `nextTick` implementation found")}();a.LT_COLLATOR=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});function h(f,u,d){if(d.batchType==="old")return f.push(...u),f;if(f.length===0)return f.push(...u),f;let b=0;for(;b<f.length&&a.LT_COLLATOR.compare(f[b].id.lt,d.maxLt)>=0;)++b;return f.splice(b,0,...u),f}a.mergeTransactions=h;const w=4294967295;let v=Math.floor(Math.random()*w);function _(){return v=(v+1)%w,v}a.getUniqueId=_})(F);Object.defineProperty(P,"__esModule",{value:!0});P.parseTokensObject=P.serializeTokensObject=P.parseAccountInteraction=P.parsePermissions=P.parseMessage=P.serializeMessage=P.parseTransaction=P.serializeTransaction=void 0;const U=F;function Z(a){return{...a,inMessage:N(a.inMessage),outMessages:a.outMessages.map(N)}}P.serializeTransaction=Z;function tt(a){return{...a,inMessage:B(a.inMessage),outMessages:a.outMessages.map(B)}}P.parseTransaction=tt;function N(a){return{...a,src:a.src?a.src.toString():void 0,dst:a.dst?a.dst.toString():void 0}}P.serializeMessage=N;function B(a){return{...a,src:a.src?new U.Address(a.src):void 0,dst:a.dst?new U.Address(a.dst):void 0}}P.parseMessage=B;function et(a){return{...a,accountInteraction:a.accountInteraction?Q(a.accountInteraction):void 0}}P.parsePermissions=et;function Q(a){return{...a,address:new U.Address(a.address)}}P.parseAccountInteraction=Q;function st(a){return $(a)}P.serializeTokensObject=st;function $(a){if(a instanceof U.Address)return a.toString();if(Array.isArray(a)){const e=[];for(const t of a)e.push($(t));return e}else if(a!=null&&typeof a=="object"){const e={};for(const[t,r]of Object.entries(a))e[t]=$(r);return e}else return a}function it(a,e){const t={};for(const r of a)t[r.name]=q(r,e[r.name]);return t}P.parseTokensObject=it;function q(a,e){if(a.type.startsWith("map")){let[t,r]=a.type.split(",");t=t.slice(4),r=r.slice(0,-1);const i=[];for(const[s,o]of e)i.push([q({name:"",type:t},s),q({name:"",type:r,components:a.components},o)]);return i}else{const t=a.type.endsWith("[]"),r=!t&&a.type.startsWith("optional"),i=t?a.type.slice(0,-2):r?a.type.slice(9,-1):a.type;if(t){const s={name:a.name,type:i,components:a.components},o=[];for(const p of e)o.push(q(s,p));return o}else if(r){if(e==null)return null;{const s={name:a.name,type:i,components:a.components};return q(s,e)}}else if(i==="tuple"){const s={};if(a.components!=null)for(const o of a.components)s[o.name]=q(o,e[o.name]);return s}else return i==="address"?new U.Address(e):e}}var H={};Object.defineProperty(H,"__esModule",{value:!0});H.Subscriber=void 0;const D=F,nt=P;class rt{constructor(e){this.provider=e,this.subscriptions=new Map,this.scanners=new Map,this.unsubscribe=async()=>this._unsubscribe()}transactions(e){return this._addSubscription("transactionsFound",e,!1)}trace(e){const t=(0,D.getUniqueId)();return new I((r,i)=>{const s=new ot(this.provider,{origin:e,onData:r,onEnd:o=>{this.scanners.delete(t),i(o)}});return this.scanners.set(t,s),s.start(),Promise.resolve()},async()=>{const r=this.scanners.get(t);r!=null&&(this.scanners.delete(t),await r.stop())},K,!0)}oldTransactions(e,t){const r=(0,D.getUniqueId)();return new I((i,s)=>{const o=new at(this.provider,{address:e,onData:i,onEnd:p=>{this.scanners.delete(r),s(p)},...t});return this.scanners.set(r,o),o.start(),Promise.resolve()},async()=>{const i=this.scanners.get(r);i!=null&&(this.scanners.delete(r),await i.stop())},K,!0)}states(e){return this._addSubscription("contractStateChanged",e,!1)}async _unsubscribe(){const e=[];for(const t of this.subscriptions.values())for(const[r,i]of Object.entries(t))delete t[r],i!=null&&e.push(i.subscription.then(s=>s.unsubscribe()).catch(()=>{}));this.subscriptions.clear();for(const t of this.scanners.values())e.push(t.stop());this.scanners.clear(),await Promise.all(e)}_addSubscription(e,t,r){const i=t.toString(),s=p=>{const h=this.subscriptions.get(i);if(h==null)return;const w=h[e];if(w!=null){const v=w.handlers.get(p);if(v!=null){w.handlers.delete(p);const{queue:_,onEnd:f,state:u}=v;u.finished||(u.finished=!0,_.clear(),_.enqueue(async()=>f(u.eof)))}if(w.handlers.size===0){const _=w.subscription;delete h[e],_.then(f=>f.unsubscribe()).catch(console.debug)}}h.contractStateChanged==null&&h.transactionsFound==null&&this.subscriptions.delete(i)},o=(0,D.getUniqueId)();return new I((p,h)=>{const w=this.subscriptions.get(i);let v=w==null?void 0:w[e];const _={eof:!1,finished:!1},f={onData:p,onEnd:h,queue:new V,state:_};if(v!=null)return v.handlers.set(o,f),Promise.resolve();const u=new Map;u.set(o,f);const d=this.provider.subscribe(e,{address:t}).then(b=>(b.on("data",A=>{for(const{onData:E,queue:M,state:y}of u.values())y.eof||y.finished||M.enqueue(async()=>{await E(A)||(y.eof=!0,s(o))})}),b.on("unsubscribed",()=>{for(const A of u.keys())s(A)}),b)).catch(b=>{console.error(b);for(const A of u.keys())s(A);throw b});return v={subscription:d,handlers:u},w==null?this.subscriptions.set(i,{[e]:v}):w[e]=v,d.then(()=>{})},()=>s(o),K,r)}}H.Subscriber=rt;async function K(a,e){return e(a)}class I{constructor(e,t,r,i){this.makeProducer=e,this.stopProducer=t,this.extractor=r,this.isFinite=i,this.fold=this.onlyFinite((s,o,p)=>{let h=s;return new Promise((w,v)=>{const _=this.makeProducer(f=>this.extractor(f,async u=>(h=await o(h,u),!0)),f=>{f?w(h):v(new Error("Subscription closed"))});p!=null&&(p.subscribed=_)})}),this.finished=this.onlyFinite(s=>new Promise((o,p)=>{const h=this.makeProducer(w=>this.extractor(w,v=>!0),w=>{w?o(void 0):p(new Error("Subscription closed"))});s!=null&&(s.subscribed=h)}))}async delayed(e){const{subscribed:t,result:r}=e({first:()=>{const i={},s=this.first(i);return{subscribed:i.subscribed,result:s}},on:i=>{const s={};return this.on(i,s),{subscribed:s.subscribed,result:void 0}},fold:this.fold!=null?(i,s)=>{const o={},p=this.fold(i,s,o);return{subscribed:o.subscribed,result:p}}:void 0,finished:this.finished!=null?()=>{const i={},s=this.finished(i);return{subscribed:i.subscribed,result:s}}:void 0});return await t,()=>r}first(e){const t={found:!1};return new Promise((r,i)=>{const s=this.makeProducer(o=>this.extractor(o,p=>(Object.assign(t,{found:!0,result:p}),!1)),o=>{o?this.isFinite?r(t.found?t.result:void 0):t.found?r(t.result):i(new Error("Unexpected end of stream")):i(new Error("Subscription closed"))});e!=null&&(e.subscribed=s)})}on(e,t){const r=this.makeProducer(i=>this.extractor(i,async s=>(await e(s),!0)),i=>{});t!=null&&(t.subscribed=r)}merge(e){return new I((t,r)=>{const i={stopped:!1,counter:0},s=o=>{i.stopped||(++i.counter==2||!o)&&(i.stopped=!0,r(o))};return Promise.all([this.makeProducer(t,s),e.makeProducer(t,s)]).then(()=>{})},()=>{this.stopProducer(),e.stopProducer()},this.extractor,this.isFinite&&e.isFinite)}enumerate(){const e={index:0};return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>r({index:e.index++,item:i})),this.isFinite)}tap(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>(await e(i),r(i))),this.isFinite)}filter(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>await e(i)?r(i):!0),this.isFinite)}filterMap(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>{const s=await e(i);return s!==void 0?r(s):!0}),this.isFinite)}map(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>{const s=await e(i);return r(s)}),this.isFinite)}flatMap(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>{const s=await e(i);for(const o of s)if(!await r(o))return!1;return!0}),this.isFinite)}skip(e){const t={index:0};return new I(this.makeProducer,this.stopProducer,(r,i)=>this.extractor(r,s=>t.index>=e?i(s):(++t.index,!0)),this.isFinite)}skipWhile(e){const t={shouldSkip:!0};return new I(this.makeProducer,this.stopProducer,(r,i)=>this.extractor(r,async s=>!t.shouldSkip||!await e(s)?(t.shouldSkip=!1,i(s)):!0),this.isFinite)}take(e){const t={index:0};return new I(this.makeProducer,this.stopProducer,(r,i)=>this.extractor(r,s=>t.index<e?(++t.index,i(s)):!1),!0)}takeWhile(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>await e(i)?r(i):!1),!0)}takeWhileMap(e){return new I(this.makeProducer,this.stopProducer,(t,r)=>this.extractor(t,async i=>{const s=await e(i);return s!==void 0?r(s):!1}),!0)}onlyFinite(e){if(this.isFinite)return e}}class at{constructor(e,t){this.provider=e,this.params=t,this.queue=new V,this.isRunning=!1}start(){this.isRunning||this.promise!=null||(this.isRunning=!0,this.promise=(async()=>{const e=this.params,t={complete:!1};for(;this.isRunning&&!t.complete;)try{const{transactions:r,continuation:i}=await this.provider.getTransactions({address:this.params.address,continuation:this.continuation});if(t.complete=!t.complete&&r.length==null,!this.isRunning||t.complete)break;const s=r.filter(p=>(e.fromLt==null||D.LT_COLLATOR.compare(p.id.lt,e.fromLt)>0)&&(e.fromUtime==null||p.createdAt>e.fromUtime));if(s.length==0){t.complete=!0;break}const o={maxLt:s[0].id.lt,minLt:s[s.length-1].id.lt,batchType:"old"};if(this.queue.enqueue(async()=>{this.params.onData({address:this.params.address,transactions:s,info:o})||(t.complete=!0,this.isRunning=!1)}),i!=null)this.continuation=i;else{t.complete=!0;break}}catch(r){console.error(r)}this.queue.enqueue(async()=>this.params.onEnd(t.complete)),this.isRunning=!1,this.continuation=void 0})())}async stop(){this.isRunning=!1,this.queue.clear(),this.promise!=null?await this.promise:this.params.onEnd(!1)}}class ot{constructor(e,t){this.provider=e,this.params=t,this.queue=new V,this.isRunning=!1,this.semaphore=new D.Semaphore(10)}start(){if(this.isRunning||this.promise!=null)return;const e=this.provider;this.isRunning=!0,this.promise=(async()=>{const t={complete:!1},r=s=>{const o={stopped:!1};return{promise:(async()=>{let w=500;for(;;){const v=await this.semaphore.acquire();if(o.stopped){v();return}const _=await e.rawApi.findTransaction({inMessageHash:s}).catch(()=>({transaction:void 0})).finally(()=>v());if(o.stopped)return;if(_.transaction!=null){const d=(0,nt.parseTransaction)(_.transaction);return d.account=d.inMessage.dst,d}let f;const u=new Promise((d,b)=>{f=()=>d(),o.reject=()=>b()});if(o.timeout=setTimeout(f,w),await u,o.stopped)return;o.reject=void 0,w=Math.min(w*2,3e3)}})(),reject:()=>{var w;o.stopped=!0,(w=o.reject)===null||w===void 0||w.call(o),o.timeout!=null&&clearTimeout(o.timeout)}}},i=[this.params.origin];try{t:for(;this.isRunning;){const s=i.shift();if(s==null){t.complete=!0;break}const o=s.outMessages.filter(p=>p.dst!=null).map(p=>{const h=p.hash;return r(h)});this.pendingTransactions=o;for(const{promise:p}of o){const h=await p;if(!this.isRunning||t.complete||h==null)break t;this.queue.enqueue(async()=>{this.params.onData(h)||(t.complete=!0,this.isRunning=!1,this.rejectPendingTransactions())}),i.push(h)}this.pendingTransactions=void 0}}catch(s){console.error(s)}finally{this.queue.enqueue(async()=>this.params.onEnd(t.complete)),this.isRunning=!1,this.rejectPendingTransactions()}})()}async stop(){this.isRunning=!1,this.queue.clear(),this.rejectPendingTransactions(),this.promise!=null?await this.promise:this.params.onEnd(!1)}rejectPendingTransactions(){if(this.pendingTransactions!=null){for(const e of this.pendingTransactions)e.reject();this.pendingTransactions=void 0}this.semaphore.releaseAll()}}class V{constructor(){this.queue=[],this.workingOnPromise=!1}enqueue(e){this.queue.push(e),this._dequeue().catch(()=>{})}clear(){this.queue.length=0}async _dequeue(){if(this.workingOnPromise)return;const e=this.queue.shift();!e||(this.workingOnPromise=!0,e().then(()=>{this.workingOnPromise=!1,this._dequeue()}).catch(()=>{this.workingOnPromise=!1,this._dequeue()}))}}var L={};Object.defineProperty(L,"__esModule",{value:!0});L.TvmException=L.Contract=void 0;const x=F,k=P;class ct{constructor(e,t,r){if(!Array.isArray(t.functions))throw new Error("Invalid abi. Functions array required");if(!Array.isArray(t.events))throw new Error("Invalid abi. Events array required");this._provider=e,this._abi=JSON.stringify(t),this._functions=t.functions.reduce((i,s)=>(i[s.name]={inputs:s.inputs||[],outputs:s.outputs||[]},i),{}),this._events=t.events.reduce((i,s)=>(i[s.name]={inputs:s.inputs||[]},i),{}),this._address=r,this._methods=new Proxy({},{get:(i,s)=>{const o=this._functions[s];return(p={})=>new ut(this._provider,o,this._abi,this._address,s,p)}})}get methods(){return this._methods}get address(){return this._address}get abi(){return this._abi}async getFullState(){return await this._provider.ensureInitialized(),await this._provider.rawApi.getFullContractState({address:this.address.toString()})}transactions(e){return e.transactions(this._address).flatMap(({transactions:t})=>t)}events(e){return e.transactions(this._address).flatMap(({transactions:t})=>t).flatMap(t=>this.decodeTransactionEvents({transaction:t}).then(r=>(r.forEach(i=>i.transaction=t),r)))}async waitForEvent(e={}){const{range:t,filter:r}=e,i=typeof r=="string"?({event:h})=>h===r:r;let s=e.subscriber;const o=s==null;s==null&&(s=new this._provider.Subscriber);const p=await((t==null?void 0:t.fromLt)!=null||(t==null?void 0:t.fromUtime)!=null?s.oldTransactions(this._address,t).merge(s.transactions(this._address)):s.transactions(this.address)).flatMap(h=>h.transactions).takeWhile(h=>t==null||(t.fromLt==null||x.LT_COLLATOR.compare(h.id.lt,t.fromLt)>0)&&(t.fromUtime==null||h.createdAt>t.fromUtime)&&(t.toLt==null||x.LT_COLLATOR.compare(h.id.lt,t.toLt)<0)&&(t.toUtime==null||h.createdAt<t.toUtime)).flatMap(h=>this.decodeTransactionEvents({transaction:h}).then(w=>(w.forEach(v=>v.transaction=h),w))).filterMap(async h=>{if(i==null||await i(h))return h}).first();return o&&await s.unsubscribe(),p}async getPastEvents(e){const{range:t,filter:r,limit:i}=e,s=typeof r=="string"?({event:h})=>h===r:r,o=[];let p=e==null?void 0:e.continuation;t:for(;;){const{transactions:h,continuation:w}=await this._provider.getTransactions({address:this._address,continuation:p});if(h.length===null)break;const v=h.filter(_=>((t==null?void 0:t.fromLt)==null||x.LT_COLLATOR.compare(_.id.lt,t.fromLt)>0)&&((t==null?void 0:t.fromUtime)==null||_.createdAt>t.fromUtime)&&((t==null?void 0:t.toLt)==null||x.LT_COLLATOR.compare(_.id.lt,t.toLt)<0)&&((t==null?void 0:t.toUtime)==null||_.createdAt<t.toUtime));if(v.length>0){const _=await Promise.all(v.map(async f=>({tx:f,events:await this.decodeTransactionEvents({transaction:f}).then(u=>(u.forEach(d=>d.transaction=f),u))})));for(let{tx:f,events:u}of _){s!=null&&(u=await Promise.all(u.map(async d=>await s(d)?d:void 0)).then(d=>d.filter(b=>b!=null))),p=f.id;for(const d of u){if(i!=null&&o.length>=i)break t;o.push(d)}if(i!=null&&o.length>=i)break t}}if(p=w,p==null)break}return{events:o,continuation:p}}async decodeTransaction(e){await this._provider.ensureInitialized();try{const t=await this._provider.rawApi.decodeTransaction({transaction:(0,k.serializeTransaction)(e.transaction),abi:this._abi,method:e.methods});if(t==null)return;const{method:r,input:i,output:s}=t,o=this._functions[r];return{method:r,input:o.inputs!=null?(0,k.parseTokensObject)(o.inputs,i):{},output:o.outputs!=null?(0,k.parseTokensObject)(o.outputs,s):{}}}catch{return}}async decodeTransactionEvents(e){await this._provider.ensureInitialized();try{const{events:t}=await this._provider.rawApi.decodeTransactionEvents({transaction:(0,k.serializeTransaction)(e.transaction),abi:this._abi}),r=[];for(const{event:i,data:s}of t){const o=this._events[i];r.push({event:i,data:o.inputs!=null?(0,k.parseTokensObject)(o.inputs,s):{}})}return r}catch{return[]}}async decodeInputMessage(e){await this._provider.ensureInitialized();try{const t=await this._provider.rawApi.decodeInput({abi:this._abi,body:e.body,internal:e.internal,method:e.methods});if(t==null)return;const{method:r,input:i}=t,s=this._functions[r];return{method:r,input:s.inputs!=null?(0,k.parseTokensObject)(s.inputs,i):{}}}catch{return}}async decodeOutputMessage(e){await this._provider.ensureInitialized();try{const t=await this._provider.rawApi.decodeOutput({abi:this._abi,body:e.body,method:e.methods});if(t==null)return;const{method:r,output:i}=t,s=this._functions[r];return{method:r,output:s.outputs!=null?(0,k.parseTokensObject)(s.outputs,i):{}}}catch{return}}async decodeEvent(e){await this._provider.ensureInitialized();try{const t=await this._provider.rawApi.decodeEvent({abi:this.abi,body:e.body,event:e.events});if(t==null)return;const{event:r,data:i}=t,s=this._events[r];return{event:r,data:s.inputs!=null?(0,k.parseTokensObject)(s.inputs,i):{}}}catch{return}}}L.Contract=ct;class G extends Error{constructor(e){super(`TvmException: ${e}`),this.code=e}}L.TvmException=G;class ut{constructor(e,t,r,i,s,o){this.provider=e,this.functionAbi=t,this.abi=r,this.address=i,this.method=s,this.params=(0,k.serializeTokensObject)(o)}async send(e){await this.provider.ensureInitialized();const{transaction:t}=await this.provider.rawApi.sendMessage({sender:e.from.toString(),recipient:this.address.toString(),amount:e.amount,bounce:e.bounce==null?!0:e.bounce,payload:{abi:this.abi,method:this.method,params:this.params},stateInit:e.stateInit});return(0,k.parseTransaction)(t)}async sendDelayed(e){await this.provider.ensureInitialized();const t=new x.DelayedTransactions,r=await this.provider.subscribe("messageStatusUpdated");r.on("data",o=>{!o.address.equals(e.from)||t.fillTransaction(o.hash,o.transaction)});const{message:i}=await this.provider.rawApi.sendMessageDelayed({sender:e.from.toString(),recipient:this.address.toString(),amount:e.amount,bounce:e.bounce==null?!0:e.bounce,payload:{abi:this.abi,method:this.method,params:this.params},stateInit:e.stateInit}).catch(o=>{throw r.unsubscribe().catch(console.error),o}),s=t.waitTransaction(this.address,i.hash).finally(()=>r.unsubscribe().catch(console.error));return{messageHash:i.hash,expireAt:i.expireAt,transaction:s}}async sendWithResult(e){await this.provider.ensureInitialized();let t=e.subscriber;const r=t==null;t==null&&(t=new this.provider.Subscriber);try{let i,s;const o=new Promise(u=>{s=d=>u(d)}),p=[];t.transactions(this.address).flatMap(u=>u.transactions).filter(u=>{var d;return((d=u.inMessage.src)===null||d===void 0?void 0:d.equals(e.from))||!1}).on(u=>{i==null?p.push(u):i.possibleMessages.findIndex(d=>d.hash==u.inMessage.hash)>=0&&(s==null||s(u))});const h=await this.send(e),w=h.outMessages.filter(u=>{var d;return((d=u.dst)===null||d===void 0?void 0:d.equals(this.address))||!1});i={transaction:h,possibleMessages:w};const v=p.find(u=>w.findIndex(d=>d.hash==u.inMessage.hash)>=0);v!=null&&(s==null||s(v));const _=await o;let f;try{const u=await this.provider.rawApi.decodeTransaction({transaction:(0,k.serializeTransaction)(_),abi:this.abi,method:this.method});u!=null&&(f=this.functionAbi.outputs!=null?(0,k.parseTokensObject)(this.functionAbi.outputs,u.output):{})}catch(u){console.error(u)}return{parentTransaction:i.transaction,childTransaction:_,output:f}}finally{r&&await t.unsubscribe()}}async estimateFees(e){await this.provider.ensureInitialized();const{fees:t}=await this.provider.rawApi.estimateFees({sender:e.from.toString(),recipient:this.address.toString(),amount:e.amount,payload:{abi:this.abi,method:this.method,params:this.params},stateInit:e.stateInit});return t}async sendExternal(e){await this.provider.ensureInitialized();const t=e.withoutSignature===!0?this.provider.rawApi.sendUnsignedExternalMessage:this.provider.rawApi.sendExternalMessage,{transaction:r,output:i}=await t({publicKey:e.publicKey,recipient:this.address.toString(),stateInit:e.stateInit,payload:{abi:this.abi,method:this.method,params:this.params},local:e.local});return{transaction:(0,k.parseTransaction)(r),output:i!=null?(0,k.parseTokensObject)(this.functionAbi.outputs,i):void 0}}async sendExternalDelayed(e){await this.provider.ensureInitialized();const t=new x.DelayedTransactions,r=await this.provider.subscribe("messageStatusUpdated");r.on("data",o=>{!o.address.equals(this.address)||t.fillTransaction(o.hash,o.transaction)});const{message:i}=await this.provider.rawApi.sendExternalMessageDelayed({publicKey:e.publicKey,recipient:this.address.toString(),stateInit:e.stateInit,payload:{abi:this.abi,method:this.method,params:this.params}}).catch(o=>{throw r.unsubscribe().catch(console.error),o}),s=t.waitTransaction(this.address,i.hash).finally(()=>r.unsubscribe().catch(console.error));return{messageHash:i.hash,expireAt:i.expireAt,transaction:s}}async call(e={}){await this.provider.ensureInitialized();const{output:t,code:r}=await this.provider.rawApi.runLocal({address:this.address.toString(),cachedState:e.cachedState,responsible:e.responsible,functionCall:{abi:this.abi,method:this.method,params:this.params}});if(t==null||r!=0)throw new G(r);return(0,k.parseTokensObject)(this.functionAbi.outputs,t)}async encodeInternal(){await this.provider.ensureInitialized();const{boc:e}=await this.provider.rawApi.encodeInternalInput({abi:this.abi,method:this.method,params:this.params});return e}}var X={};Object.defineProperty(X,"__esModule",{value:!0});(function(a){var e=C&&C.__createBinding||(Object.create?function(y,n,c,l){l===void 0&&(l=c);var m=Object.getOwnPropertyDescriptor(n,c);(!m||("get"in m?!n.__esModule:m.writable||m.configurable))&&(m={enumerable:!0,get:function(){return n[c]}}),Object.defineProperty(y,l,m)}:function(y,n,c,l){l===void 0&&(l=c),y[l]=n[c]}),t=C&&C.__setModuleDefault||(Object.create?function(y,n){Object.defineProperty(y,"default",{enumerable:!0,value:n})}:function(y,n){y.default=n}),r=C&&C.__importStar||function(y){if(y&&y.__esModule)return y;var n={};if(y!=null)for(var c in y)c!=="default"&&Object.prototype.hasOwnProperty.call(y,c)&&e(n,y,c);return t(n,y),n},i=C&&C.__exportStar||function(y,n){for(var c in y)c!=="default"&&!Object.prototype.hasOwnProperty.call(n,c)&&e(n,y,c)};Object.defineProperty(a,"__esModule",{value:!0}),a.ProviderNotInitializedException=a.ProviderNotFoundException=a.ProviderRpcClient=a.hasEverscaleProvider=a.LT_COLLATOR=a.mergeTransactions=a.MessageExpiredException=a.AddressLiteral=a.Address=a.Subscriber=void 0;const s=P,o=F,p=r(H),h=r(L);i(X,a),i(P,a),i(L,a);var w=H;Object.defineProperty(a,"Subscriber",{enumerable:!0,get:function(){return w.Subscriber}});var v=F;Object.defineProperty(a,"Address",{enumerable:!0,get:function(){return v.Address}}),Object.defineProperty(a,"AddressLiteral",{enumerable:!0,get:function(){return v.AddressLiteral}}),Object.defineProperty(a,"MessageExpiredException",{enumerable:!0,get:function(){return v.MessageExpiredException}}),Object.defineProperty(a,"mergeTransactions",{enumerable:!0,get:function(){return v.mergeTransactions}}),Object.defineProperty(a,"LT_COLLATOR",{enumerable:!0,get:function(){return v.LT_COLLATOR}});const _=typeof window<"u"&&typeof window.document<"u";let f;!_||document.readyState==="complete"?f=Promise.resolve():f=new Promise(y=>{window.addEventListener("load",()=>{y()})});const u=()=>_?window.__ever||window.ton:void 0;async function d(){return _?(await f,window.__hasEverscaleProvider===!0||window.hasTonProvider===!0):!1}a.hasEverscaleProvider=d;class b{constructor(n={}){this._subscriptions={connected:new Map,disconnected:new Map,transactionsFound:new Map,contractStateChanged:new Map,messageStatusUpdated:new Map,networkChanged:new Map,permissionsChanged:new Map,loggedOut:new Map},this._contractSubscriptions=new Map,this._properties=n;const c=this;class l extends h.Contract{constructor(g,S){super(c,g,S)}}this.Contract=l;class m extends p.Subscriber{constructor(){super(c)}}this.Subscriber=m,this._api=new Proxy({},{get:(T,g)=>S=>{if(this._provider!=null)return this._provider.request({method:g,params:S});throw new E}}),n.forceUseFallback===!0?this._initializationPromise=n.fallback!=null?n.fallback().then(T=>{this._provider=T}):Promise.resolve():(this._provider=u(),this._provider!=null?this._initializationPromise=Promise.resolve():this._initializationPromise=d().then(T=>new Promise(g=>{if(!T)return g();if(this._provider=u(),this._provider!=null)g();else{const S=window.__hasEverscaleProvider===!0?"ever#initialized":"ton#initialized";window.addEventListener(S,O=>{this._provider=u(),g()})}})).then(async()=>{this._provider==null&&n.fallback!=null&&(this._provider=await n.fallback())})),this._initializationPromise.then(()=>{this._provider!=null&&this._registerEventHandlers(this._provider)})}async hasProvider(){return this._properties.fallback!=null?!0:d()}async ensureInitialized(){if(await this._initializationPromise,this._provider==null)throw new A}get isInitialized(){return this._provider!=null}get raw(){if(this._provider!=null)return this._provider;throw new E}get rawApi(){return this._api}createContract(n,c){return new this.Contract(n,c)}createSubscriber(){return new this.Subscriber}async requestPermissions(n){await this.ensureInitialized();const c=await this._api.requestPermissions({permissions:n.permissions});return(0,s.parsePermissions)(c)}async changeAccount(){await this.ensureInitialized(),await this._api.changeAccount()}async disconnect(){await this.ensureInitialized(),await this._api.disconnect()}async subscribe(n,c){class l{constructor(S,O){this._subscribe=S,this._unsubscribe=O,this._listeners={data:[],subscribed:[],unsubscribed:[]},this._subscribed=!1,this.subscribe=async()=>{if(!this._subscribed){this._subscribed=!0,await this._subscribe(this);for(const z of this._listeners.subscribed)z()}},this.unsubscribe=async()=>{if(!!this._subscribed){this._subscribed=!1,await this._unsubscribe();for(const z of this._listeners.unsubscribed)z()}}}on(S,O){return this._listeners[S].push(O),this}notify(S){for(const O of this._listeners.data)O(S)}}const m=this._subscriptions[n],T=(0,o.getUniqueId)();switch(n){case"connected":case"disconnected":case"messageStatusUpdated":case"networkChanged":case"permissionsChanged":case"loggedOut":{const g=new l(async S=>{m.has(T)||m.set(T,O=>{S.notify(O)})},async()=>{m.delete(T)});return await g.subscribe(),g}case"transactionsFound":case"contractStateChanged":{if(c==null)throw new Error("Address must be specified for the subscription");await this.ensureInitialized();const g=c.address.toString(),S=new l(async O=>{if(m.has(T))return;m.set(T,W=>{W.address.toString()===g&&O.notify(W)});let z=this._contractSubscriptions.get(g);z==null&&(z=new Map,this._contractSubscriptions.set(g,z));const R={state:n==="contractStateChanged",transactions:n==="transactionsFound"};z.set(T,R);const{total:j,withoutExcluded:J}=M(z.values(),R);try{(j.transactions!==J.transactions||j.state!==J.state)&&await this.rawApi.subscribe({address:g,subscriptions:j})}catch(W){throw m.delete(T),z.delete(T),W}},async()=>{m.delete(T);const O=this._contractSubscriptions.get(g);if(O==null)return;const z=O.get(T),{total:R,withoutExcluded:j}=M(O.values(),z);O.delete(T),!j.transactions&&!j.state?await this.rawApi.unsubscribe({address:g}):(R.transactions!==j.transactions||R.state!==j.state)&&await this.rawApi.subscribe({address:g,subscriptions:j})});return await S.subscribe(),S}default:throw new Error(`Unknown event ${n}`)}}async getProviderState(){await this.ensureInitialized();const n=await this._api.getProviderState();return{...n,permissions:(0,s.parsePermissions)(n.permissions)}}async getBalance(n){const{state:c}=await this.getFullContractState({address:n});return c==null?"0":c==null?void 0:c.balance}async getFullContractState(n){return await this.ensureInitialized(),await this._api.getFullContractState({address:n.address.toString()})}async getAccountsByCodeHash(n){await this.ensureInitialized();const{accounts:c,continuation:l}=await this._api.getAccountsByCodeHash({...n});return{accounts:c.map(m=>new o.Address(m)),continuation:l}}async getTransactions(n){await this.ensureInitialized();const{transactions:c,continuation:l,info:m}=await this._api.getTransactions({...n,address:n.address.toString()});return{transactions:c.map(s.parseTransaction),continuation:l,info:m}}async getTransaction(n){await this.ensureInitialized();const{transaction:c}=await this._api.getTransaction({...n});return{transaction:c?(0,s.parseTransaction)(c):void 0}}async getExpectedAddress(n,c){const{address:l}=await this.getStateInit(n,c);return l}async getStateInit(n,c){await this.ensureInitialized();const{address:l,stateInit:m}=await this._api.getExpectedAddress({abi:JSON.stringify(n),...c,initParams:(0,s.serializeTokensObject)(c.initParams)});return{address:new o.Address(l),stateInit:m}}async getBocHash(n){return await this.ensureInitialized(),await this._api.getBocHash({boc:n}).then(({hash:c})=>c)}async packIntoCell(n){return await this.ensureInitialized(),await this._api.packIntoCell({abiVersion:n.abiVersion,structure:n.structure,data:(0,s.serializeTokensObject)(n.data)})}async unpackFromCell(n){await this.ensureInitialized();const{data:c}=await this._api.unpackFromCell({...n,structure:n.structure});return{data:(0,s.parseTokensObject)(n.structure,c)}}async extractPublicKey(n){await this.ensureInitialized();const{publicKey:c}=await this._api.extractPublicKey({boc:n});return c}async codeToTvc(n){await this.ensureInitialized();const{tvc:c}=await this._api.codeToTvc({code:n});return c}async mergeTvc(n){return await this.ensureInitialized(),await this._api.mergeTvc(n)}async splitTvc(n){return await this.ensureInitialized(),await this._api.splitTvc({tvc:n})}async setCodeSalt(n){let c;if(typeof n.salt=="string")await this.ensureInitialized(),c=n.salt;else{const{boc:l}=await this.packIntoCell(n.salt);c=l}return await this._api.setCodeSalt({code:n.code,salt:c})}async getCodeSalt(n){await this.ensureInitialized();const{salt:c}=await this.rawApi.getCodeSalt({code:n.code});return c}async addAsset(n){await this.ensureInitialized();let c;switch(n.type){case"tip3_token":{c={rootContract:n.params.rootContract.toString()};break}default:throw new Error("Unknown asset type")}return await this._api.addAsset({account:n.account.toString(),type:n.type,params:c})}async verifySignature(n){return await this.ensureInitialized(),await this._api.verifySignature(n)}async signData(n){return await this.ensureInitialized(),await this._api.signData(n)}async signDataRaw(n){return await this.ensureInitialized(),await this._api.signDataRaw(n)}async encryptData(n){await this.ensureInitialized();const{encryptedData:c}=await this._api.encryptData(n);return c}async decryptData(n){await this.ensureInitialized();const{data:c}=await this._api.decryptData({encryptedData:n});return c}async sendMessage(n){await this.ensureInitialized();const{transaction:c}=await this._api.sendMessage({sender:n.sender.toString(),recipient:n.recipient.toString(),amount:n.amount,bounce:n.bounce,payload:n.payload?{abi:n.payload.abi,method:n.payload.method,params:(0,s.serializeTokensObject)(n.payload.params)}:void 0,stateInit:n.stateInit});return{transaction:(0,s.parseTransaction)(c)}}async sendMessageDelayed(n){await this.ensureInitialized();const c=new o.DelayedTransactions,l=await this.subscribe("messageStatusUpdated");l.on("data",g=>{!g.address.equals(n.sender)||c.fillTransaction(g.hash,g.transaction)});const{message:m}=await this._api.sendMessageDelayed({sender:n.sender.toString(),recipient:n.recipient.toString(),amount:n.amount,bounce:n.bounce,payload:n.payload?{abi:n.payload.abi,method:n.payload.method,params:(0,s.serializeTokensObject)(n.payload.params)}:void 0,stateInit:n.stateInit}).catch(g=>{throw l.unsubscribe().catch(console.error),g}),T=c.waitTransaction(n.sender,m.hash).finally(()=>l.unsubscribe().catch(console.error));return{messageHash:m.hash,expireAt:m.expireAt,transaction:T}}_registerEventHandlers(n){const c={connected:l=>l,disconnected:l=>l,transactionsFound:l=>({address:new o.Address(l.address),transactions:l.transactions.map(s.parseTransaction),info:l.info}),contractStateChanged:l=>({address:new o.Address(l.address),state:l.state}),messageStatusUpdated:l=>({address:new o.Address(l.address),hash:l.hash,transaction:l.transaction!=null?(0,s.parseTransaction)(l.transaction):void 0}),networkChanged:l=>l,permissionsChanged:l=>({permissions:(0,s.parsePermissions)(l.permissions)}),loggedOut:l=>l};for(const[l,m]of Object.entries(c))n.addListener(l,T=>{const g=this._subscriptions[l],S=m(T);for(const O of g.values())O(S)})}}a.ProviderRpcClient=b;class A extends Error{constructor(){super("Everscale provider was not found")}}a.ProviderNotFoundException=A;class E extends Error{constructor(){super("Everscale provider was not initialized yet")}}a.ProviderNotInitializedException=E;function M(y,n){const c={state:!1,transactions:!1},l=Object.assign({},c);for(const m of y){if(l.transactions&&l.state)break;c.state||(c.state=m.state),c.transactions||(c.transactions=m.transactions),m!==n&&(l.state||(l.state=m.state),l.transactions||(l.transactions=m.transactions))}return{total:c,withoutExcluded:l}}})(Y);export{Y as d};
